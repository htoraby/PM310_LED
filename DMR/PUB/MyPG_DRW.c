#include <Main.h>

const WORD c_wDRWBitmap[36][15]={
0xff7f,0x0140,0xc141,0xc141,0xc141,0xc141,0xc1c1,0xc1c1,0xc1c1,0xc141,0xc141,0xc141,0xc141,0x0140,0xff7f,
0xff7f,0x0140,0x0140,0x0140,0x0140,0x0140,0xfddf,0xfddf,0xfddf,0x0140,0x0140,0x0140,0x0140,0x0140,0xff7f,
0xe003,0x180c,0xc411,0xc221,0xc221,0xc141,0xc1c1,0xc1c1,0xc1c1,0xc141,0xc221,0xc221,0xc411,0x180c,0xe003,
0xe003,0x180c,0x0410,0x0220,0x0220,0x0140,0xfddf,0xfddf,0xfddf,0x0140,0x0220,0x0220,0x0410,0x180c,0xe003,
0x0000,0x0000,0x0000,0xfc3f,0x0420,0x0420,0x07e0,0x07e0,0x07e0,0x0420,0x0420,0xfc3f,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0xfc3f,0xfc3f,0xfc3f,0xffff,0xffff,0xffff,0xfc3f,0xfc3f,0xfc3f,0x0000,0x0000,0x0000,
0x0000,0x0000,0xc001,0x3006,0x0808,0x0808,0x07f0,0x07f0,0x07f0,0x0808,0x0808,0x3006,0xc001,0x0000,0x0000,
0x0000,0x0000,0xc001,0xf007,0xf80f,0xf80f,0xffff,0xffff,0xffff,0xf80f,0xf80f,0xf007,0xc001,0x0000,0x0000,
0x0000,0x0000,0x9801,0x3003,0x6006,0xc00c,0xfff9,0xfff3,0xfff9,0xc00c,0x6006,0x3003,0x9801,0x0000,0x0000,
0x0000,0x0000,0x8001,0x0003,0x0006,0x000c,0x1ff8,0x1ff0,0x1ff8,0x000c,0x0006,0x0003,0x8001,0x0000,0x0000,
0x0000,0x0000,0x8001,0x0003,0x0006,0x000c,0x07f8,0x07f0,0x07f8,0x040c,0x0406,0x0403,0x8401,0x0e00,0x0400,
0x0000,0x0000,0x8019,0xc00c,0x6006,0x3003,0x9fff,0xcfff,0x9fff,0x3003,0x6006,0xc00c,0x8019,0x0000,0x0000,
0x0000,0x0000,0x8001,0xc000,0x6000,0x3000,0x1ff8,0x0ff8,0x1ff8,0x3000,0x6000,0xc000,0x8001,0x0000,0x0000,
0x0000,0x0000,0x8001,0xc000,0x6000,0x3000,0x1fe0,0x0fe0,0x1fe0,0x3020,0x6020,0xc020,0x8021,0x0070,0x0020,
0x0000,0x0000,0x0018,0x0006,0x8001,0x6028,0x1bf8,0x07f0,0x03f8,0x0028,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0028,0xfbff,0x0ff0,0x03f8,0x0028,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0018,0x0006,0x8001,0x6010,0x1bf0,0x07f0,0x03f0,0x0010,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0010,0xfbff,0x0ff0,0x03f0,0x0010,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0018,0x0006,0x8001,0x6010,0x1bf4,0x07fa,0x03f4,0x0010,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0xf81f,0x0bfc,0x0ffa,0x03f4,0x0010,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x801b,0x6006,0x9805,0x6816,0x9bf1,0x77f0,0x03f0,0x0010,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0xf807,0x0814,0xffff,0x0bf4,0xfbf7,0x0010,0x0000,0x0000,0x0000,0x0000,0x0000,
0x0007,0x8008,0x400a,0x2008,0x1004,0x0802,0x0c31,0x9248,0x6db4,0x2db4,0x1248,0x0c30,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xfc3f,0x1248,0x2db4,0x2db4,0x1248,0xfc3f,0x0000,0x0000,0x0000,
0xc003,0x300c,0x0810,0x0420,0xf42f,0xf24f,0x02c2,0x82c1,0x02c2,0xf24f,0xf42f,0x0420,0x0810,0x300c,0xc003,
0xc003,0x300c,0x0810,0x8423,0x0426,0x0244,0x02c6,0xc2c3,0x62c0,0x2240,0x6420,0xc421,0x0810,0x300c,0xc003,
0x0000,0x8001,0xc007,0xc00e,0xc018,0xc018,0xcfff,0xcfff,0xcfff,0x0818,0x1818,0x700e,0xe007,0x8001,0x0000,
0x0004,0x0006,0x0007,0x8007,0xc006,0x6006,0xffff,0xffff,0xffff,0x6006,0xc006,0x8007,0x0007,0x0006,0x0004,
0x0000,0x6006,0x6006,0x6006,0x6006,0x6006,0x7ffe,0x7ffe,0x7ffe,0x6006,0x6006,0x6006,0x6006,0x6006,0x0000,
0x0000,0x0003,0x0003,0x0003,0x6003,0x6003,0x6cff,0x6cff,0x6cff,0x6003,0x6003,0x0003,0x0003,0x0003,0x0000,
0x0000,0x0000,0x8003,0x600c,0x1010,0x1010,0x0820,0xffff,0x0820,0x1010,0x1010,0x600c,0x8003,0x0001,0x8003,
0x0000,0x0000,0x0000,0x700e,0x8c31,0x8421,0x4242,0xffff,0x4242,0x8421,0x8c31,0x700e,0x2004,0x700e,0x2004,
0x0000,0x0000,0x0000,0xfe3f,0x0220,0x1a20,0xfa20,0xffe7,0xfa20,0x1a20,0x0220,0xfe3f,0x0000,0x0000,0x0000,
0x0000,0x0000,0x0000,0xc001,0xf007,0xf007,0xc809,0x8ff8,0xc809,0xf007,0xf007,0xc001,0x0000,0x0000,0x0000,
0x0000,0x0000,0x4002,0x4002,0x4002,0x4002,0x4002,0x7ffe,0x4002,0x4002,0x4002,0x4002,0x4002,0x0000,0x0000,
0x0000,0x0000,0x0001,0x0001,0x2001,0x2001,0x2401,0x24ff,0x2401,0x2001,0x2001,0x0001,0x0001,0x0000,0x0000
};


//-----------------------------------------------------------------------------
WORD PGDRW_GetStatusLinkIN(WORD wLinkIN)
{
	WORD wStatusLinkIN;
	if(wLinkIN==0) return 0;
	wLinkIN--;
	wStatusLinkIN = 0;
	if(wLinkIN<32)
	{
		if(wLinkIN<16) wStatusLinkIN = g_deviceInfo.wSwitchStatus1&(SS_IN01<<wLinkIN);
		else if(wLinkIN<32) wStatusLinkIN = g_deviceInfo.wSwitchStatus2&(SS_IN01<<(wLinkIN-16));
	}
#ifdef _CMYPROTECT_H
	else if(wLinkIN<64)
	{
		wStatusLinkIN = (g_wProtectRun[wLinkIN-32]==PROTECTTOG_ON)?1:0;
	}
#endif/*_CMYPROTECT_H*/
	else return 0;
	return (wStatusLinkIN)?0x5555:0x3333;
}

void PGDRW_DrawHLine(DRW_HLINE* pDRW)
{
	g_wLCDAutoPosX = pDRW->wPointX+pDRW->wLength;
	switch(pDRW->wLineType)
	{
	case 0: LCD_DrawHLineExt(pDRW->wPointY,pDRW->wPointX,g_wLCDAutoPosX,0xaa); break;
	case 2:
		LCD_DrawHLine((WORD)(pDRW->wPointY-1),pDRW->wPointX,g_wLCDAutoPosX);
		LCD_DrawHLine((WORD)(pDRW->wPointY+1),pDRW->wPointX,g_wLCDAutoPosX);
	case 1:
		LCD_DrawHLine(pDRW->wPointY,pDRW->wPointX,g_wLCDAutoPosX);
		break;
	}
}

void PGDRW_DrawVLine(DRW_VLINE* pDRW)
{
	g_wLCDAutoPosY = pDRW->wPointY+pDRW->wLength;
	switch(pDRW->wLineType)
	{
	case 0: LCD_DrawVLineExt(pDRW->wPointX,pDRW->wPointY,g_wLCDAutoPosY,0xaa); break;
	case 2:
		LCD_DrawVLine((WORD)(pDRW->wPointX-1),pDRW->wPointY,g_wLCDAutoPosY);
		LCD_DrawVLine((WORD)(pDRW->wPointX+1),pDRW->wPointY,g_wLCDAutoPosY);
	case 1:
		LCD_DrawVLine(pDRW->wPointX,pDRW->wPointY,g_wLCDAutoPosY);
		break;
	}
}

void PGDRW_DrawXLine(DRW_XLINE* pDRW)
{
	g_wLCDAutoPosX = pDRW->wPointX+pDRW->wWidth;
	g_wLCDAutoPosY = pDRW->wPointY+pDRW->wHeight;
	if(pDRW->bTopLeft)
	{
		LCD_DrawXLine(pDRW->wPointX,pDRW->wPointY,g_wLCDAutoPosX,g_wLCDAutoPosY);
	}
	else
	{
		LCD_DrawXLine(pDRW->wPointX,g_wLCDAutoPosY,g_wLCDAutoPosX,pDRW->wPointY);
	}
}

void PGDRW_DrawCircle(DRW_CIRCLE* pDRW)
{
	LCD_DrawCircle(pDRW->wPointX,pDRW->wPointY,pDRW->wRadio);
}

void PGDRW_DrawErase(DRW_ERASE* pDRW)
{
	WORD wLCDColorOld;
	WORD i;

	wLCDColorOld = g_wLCDColor;
	LCD_SetColor(g_wLCDColorBK);
	for(i=0;i<pDRW->wHeight;i++)
	{
		LCD_DrawHLine((WORD)(pDRW->wPointY+i),pDRW->wPointX,(WORD)(pDRW->wPointX+pDRW->wWidth));
	}
	LCD_SetColor(wLCDColorOld);
}

void PGDRW_DrawText(DRW_TEXT* pDRW)
{
	char szText[10];
	WORD wLength;
	BOOL bModeASCII;
	WORD i;

	wLength = pDRW->wszText[0]&0xff;
	if(wLength>9) wLength = 9;
	szText[0] = (char)(pDRW->wszText[0]>>8);
	szText[1] = (char)(pDRW->wszText[1]&0xff);
	szText[2] = (char)(pDRW->wszText[1]>>8);
	szText[3] = (char)(pDRW->wszText[2]&0xff);
	szText[4] = (char)(pDRW->wszText[2]>>8);
	szText[5] = (char)(pDRW->wszText[3]&0xff);
	szText[6] = (char)(pDRW->wszText[3]>>8);
	szText[7] = (char)(pDRW->wszText[4]&0xff);
	szText[8] = (char)(pDRW->wszText[4]>>8);
	szText[wLength] = 0;
	bModeASCII = TRUE;
	for(i=0;i<wLength;i++)
	{
		if((BYTE)szText[i]>=128) bModeASCII = FALSE;
	}
	if(bModeASCII) LCD_AsciiOut((WORD)(pDRW->wPointX+1),pDRW->wPointY,szText);
	else LCD_TextOut(pDRW->wPointX,pDRW->wPointY,szText);
}

void PGDRW_DrawAnalog(DRW_ANALOG* pDRW)
{
	g_wLCDAutoPosX = pDRW->wPointX+1;
	g_wLCDAutoPosY = pDRW->wPointY;
	if(pDRW->wLinkAnalog) MyHMI_AutoLCDDataOut((WORD)(INDEX_ANALOG+pDRW->wLinkAnalog));
	else LCD_AutoAsciiOut("----");
}

void PGDRW_DrawBlock(DRW_BLOCK* pDRW)
{
	LCD_ImageOut(pDRW->wPointX,pDRW->wPointY,15,16,(WORD*)c_wDRWBitmap[pDRW->wBlockType+24]);
}

void PGDRW_DrawBlockDyn(DRW_BLOCKDYN* pDRW)
{
	WORD wStatusIN1;
	WORD wStatusIN2;
	WORD wIndex;

	wIndex = 0;
	wStatusIN1 = PGDRW_GetStatusLinkIN(pDRW->wLinkIN1);
	wStatusIN2 = PGDRW_GetStatusLinkIN(pDRW->wLinkIN2);

	if(wStatusIN1==0x5555) wIndex = 1;
	switch(pDRW->wBlockType)
	{
	case 0: wIndex += 0; break;
	case 1: wIndex += 2; break;
	case 2: wIndex += 4; break;
	case 3: wIndex += 6; break;
	case 4:
	case 5:
		wIndex = 0;
		if(wStatusIN2==0x5555) wIndex = 1;
		if(wStatusIN1==0x3333 && wStatusIN2==0x3333) wIndex = 2;
		if(pDRW->wBlockType==4) wIndex += 8;
		else wIndex += 11;
		break;
	case 6: wIndex += 14; break;
	case 7: wIndex += 16; break;
	case 8: wIndex += 18; break;
	case 9: wIndex += 20; break;
	case 10: wIndex += 22; break;
	default: return;
	}
	LCD_ImageOut(pDRW->wPointX,pDRW->wPointY,15,16,(WORD*)c_wDRWBitmap[wIndex]);
}

void PGDRW_OnRefreshPage(WORD wRefreshMode)
{
	WORD* pTemp;
	WORD i;
	DRW_BASE* pDRW;

	LCD_SetSmallFont();
	pTemp = g_deviceDRW.wReserved;
	for(i=0;i<g_deviceDRW.wCount;i++)
	{
		if(i>=COUNTDRWMAX) break;
		pDRW = (DRW_BASE*)pTemp;
		switch(pDRW->wType)
		{
		case DRWTYPE_HLINE:
			if(wRefreshMode) PGDRW_DrawHLine((DRW_HLINE*)pDRW);
			pTemp += SIZEOFWORD(DRW_HLINE);
			break;
		case DRWTYPE_VLINE:
			if(wRefreshMode) PGDRW_DrawVLine((DRW_VLINE*)pDRW);
			pTemp += SIZEOFWORD(DRW_VLINE);
			break;
		case DRWTYPE_XLINE:
			if(wRefreshMode) PGDRW_DrawXLine((DRW_XLINE*)pDRW);
			pTemp += SIZEOFWORD(DRW_XLINE);
			break;
		case DRWTYPE_CIRCLE:
			if(wRefreshMode) PGDRW_DrawCircle((DRW_CIRCLE*)pDRW);
			pTemp += SIZEOFWORD(DRW_CIRCLE);
			break;
		case DRWTYPE_ERASE:
			if(wRefreshMode) PGDRW_DrawErase((DRW_ERASE*)pDRW);
			pTemp += SIZEOFWORD(DRW_ERASE);
			break;
		case DRWTYPE_TEXT:
			if(wRefreshMode) PGDRW_DrawText((DRW_TEXT*)pDRW);
			pTemp += (((DRW_TEXT*)pDRW)->wszText[0]&0xff)/2+4;
			break;
		case DRWTYPE_ANALOG:
			PGDRW_DrawAnalog((DRW_ANALOG*)pDRW);
			pTemp += SIZEOFWORD(DRW_ANALOG);
			break;
		case DRWTYPE_BLOCK:
			if(wRefreshMode) PGDRW_DrawBlock((DRW_BLOCK*)pDRW);
			pTemp += SIZEOFWORD(DRW_BLOCK);
			break;
		case DRWTYPE_BLOCKDYN:
			PGDRW_DrawBlockDyn((DRW_BLOCKDYN*)pDRW);
			pTemp += SIZEOFWORD(DRW_BLOCKDYN);
			break;
		default: return;
		}
	}
	LCD_DateOut(LCD_CXDOT/2-52,LCD_CYDOT-10,g_deviceTime.wYear,g_deviceTime.wMonth,g_deviceTime.wDay);
	LCD_TimeOut(LCD_CXDOT/2+4,LCD_CYDOT-10,g_deviceTime.wHour,g_deviceTime.wMinute,g_deviceTime.wSecond,0xffff);
}
